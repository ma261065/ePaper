"""Simple bitmap font for rendering crisp text without PIL/Pillow dependency."""

# 5x7 bitmap font (each character is 5 pixels wide, 7 pixels tall)
# Data stored in bits 7-3 of each byte, with bits 2-0 as padding
# Bits 7-3 represent pixels left-to-right
BITMAP_FONT = {
    ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    '0': [0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70],  # .###. / #...# / etc
    '1': [0x20, 0x60, 0x20, 0x20, 0x20, 0x20, 0x70],  # ..#.. / .##.. / etc
    '2': [0x70, 0x88, 0x08, 0x30, 0x40, 0x80, 0xF8],  # .###. / ...#. / etc
    '3': [0xF8, 0x08, 0x10, 0x30, 0x08, 0x88, 0x70],  # ##### / ...#. / etc
    '4': [0x10, 0x30, 0x50, 0x90, 0xF8, 0x10, 0x10],  # ..#.. / .##.. / ..#.. / etc
    '5': [0xF8, 0x80, 0xF0, 0x08, 0x08, 0x88, 0x70],  # ##### / #.... / .###. / etc
    '6': [0x30, 0x40, 0x80, 0xF0, 0x88, 0x88, 0x70],  # ..##. / .#... / .#### / etc
    '7': [0xF8, 0x08, 0x10, 0x20, 0x40, 0x80, 0x80],  # ##### / ...#. / etc
    '8': [0x70, 0x88, 0x88, 0x70, 0x88, 0x88, 0x70],  # .###. / #...# / .###. / etc
    '9': [0x70, 0x88, 0x88, 0x78, 0x08, 0x10, 0x60],  # .###. / #...# / .#### / etc
    'A': [0x20, 0x50, 0x88, 0x88, 0xF8, 0x88, 0x88],  # ..#.. / .#.#. / #...# / ##### / etc
    'B': [0xF0, 0x88, 0x88, 0xF0, 0x88, 0x88, 0xF0],  # ####. / #...# / ####. / etc
    'C': [0x70, 0x88, 0x80, 0x80, 0x80, 0x88, 0x70],  # .###. / #.... / #.... / .###. / etc
    'D': [0xE0, 0x90, 0x88, 0x88, 0x88, 0x90, 0xE0],  # ###.. / #..#. / etc
    'E': [0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0xF8],  # ##### / #.... / ####. / #.... / etc
    'F': [0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0x80],  # ##### / #.... / ####. / #.... / etc
    'G': [0x70, 0x88, 0x80, 0xB8, 0x88, 0x88, 0x70],  # .###. / #.... / #.### / etc
    'H': [0x88, 0x88, 0x88, 0xF8, 0x88, 0x88, 0x88],  # #...# / #...# / ##### / etc
    'I': [0x70, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70],  # .###. / ..#.. / ..#.. / .###. / etc
    'J': [0x38, 0x10, 0x10, 0x10, 0x10, 0x90, 0x60],  # ..### / ...#. / ...#. / etc
    'K': [0x88, 0x90, 0xA0, 0xC0, 0xA0, 0x90, 0x88],  # #...# / #..#. / .#.#. / #...# / etc
    'L': [0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xF8],  # #.... / #.... / ##### / etc
    'M': [0x88, 0xD8, 0xA8, 0xA8, 0x88, 0x88, 0x88],  # #...# / ##.## / #.#.# / etc
    'N': [0x88, 0xC8, 0xA8, 0x98, 0x88, 0x88, 0x88],  # #...# / ##..# / #.#.# / etc
    'O': [0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70],  # .###. / #...# / .###. / etc
    'P': [0xF0, 0x88, 0x88, 0xF0, 0x80, 0x80, 0x80],  # ####. / #...# / ####. / #.... / etc
    'Q': [0x70, 0x88, 0x88, 0x88, 0x88, 0x98, 0x68],  # .###. / #...# / #..## / etc
    'R': [0xF0, 0x88, 0x88, 0xF0, 0xA0, 0x90, 0x88],  # ####. / #...# / ####. / .#.#. / etc
    'S': [0x70, 0x88, 0x80, 0x70, 0x08, 0x88, 0x70],  # .###. / #.... / .###. / ....# / .###. / etc
    'T': [0xF8, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20],  # ##### / ..#.. / ..#.. / etc
    'U': [0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70],  # #...# / #...# / .###. / etc
    'V': [0x88, 0x88, 0x88, 0x88, 0x88, 0x50, 0x20],  # #...# / #...# / .#.#. / ..#.. / etc
    'W': [0x88, 0x88, 0x88, 0xA8, 0xA8, 0xD8, 0x88],  # #...# / #.#.# / #.#.# / etc
    'X': [0x88, 0x88, 0x50, 0x20, 0x50, 0x88, 0x88],  # #...# / .#.#. / ..#.. / .#.#. / #...# / etc
    'Y': [0x88, 0x88, 0x50, 0x20, 0x20, 0x20, 0x20],  # #...# / .#.#. / ..#.. / etc
    'Z': [0xF8, 0x08, 0x10, 0x20, 0x40, 0x80, 0xF8],  # ##### / ...#. / ..#.. / .#... / ##### / etc
    ':': [0x00, 0x20, 0x20, 0x00, 0x20, 0x20, 0x00],  # ..#.. / ..#.. space / etc
    '.': [0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20],  # ..#.. at bottom / etc
    '-': [0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00],  # .###. / etc
    '/': [0x08, 0x10, 0x20, 0x20, 0x40, 0x80, 0x80],  # ...#. / ..#.. / .#... / etc
    '%': [0xC0, 0xC8, 0x10, 0x20, 0x40, 0x98, 0x18],  # ##... / ##.#. / etc
    'Â°': [0x20, 0x50, 0x20, 0x00, 0x00, 0x00, 0x00],  # ..#.. / .#.#. / ..#.. / etc
    "'": [0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00],  # ..#.. / ..#..
}

# Distinct lowercase glyphs (5x7, bits 7-3 used)
BITMAP_FONT.update({
    'a': [0x00, 0x70, 0x10, 0x70, 0x90, 0x90, 0x70],
    'b': [0x80, 0x80, 0xE0, 0x90, 0x90, 0x90, 0xE0],
    'c': [0x00, 0x70, 0x80, 0x80, 0x80, 0x80, 0x70],
    'd': [0x10, 0x10, 0x70, 0x90, 0x90, 0x90, 0x70],
    'e': [0x00, 0x70, 0x90, 0xF0, 0x80, 0x80, 0x70],
    'f': [0x30, 0x40, 0xE0, 0x40, 0x40, 0x40, 0x40],
    'g': [0x00, 0x70, 0x90, 0x90, 0x70, 0x10, 0xE0],
    'h': [0x80, 0x80, 0xE0, 0x90, 0x90, 0x90, 0x90],
    'i': [0x20, 0x00, 0x60, 0x20, 0x20, 0x20, 0x70],
    'j': [0x10, 0x00, 0x30, 0x10, 0x10, 0x90, 0x60],
    'k': [0x80, 0x80, 0x90, 0xA0, 0xC0, 0xA0, 0x90],
    'l': [0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70],
    'm': [0x00, 0xD0, 0xA8, 0xA8, 0xA8, 0xA8, 0x88],
    'n': [0x00, 0xE0, 0x90, 0x90, 0x90, 0x90, 0x90],
    'o': [0x00, 0x60, 0x90, 0x90, 0x90, 0x90, 0x60],
    'p': [0x00, 0xE0, 0x90, 0x90, 0xE0, 0x80, 0x80],
    'q': [0x00, 0x70, 0x90, 0x90, 0x70, 0x10, 0x10],
    'r': [0x00, 0xB0, 0xC0, 0x80, 0x80, 0x80, 0x80],
    's': [0x00, 0x70, 0x80, 0x70, 0x10, 0x10, 0xE0],
    't': [0x40, 0xE0, 0x40, 0x40, 0x40, 0x40, 0x30],
    'u': [0x00, 0x90, 0x90, 0x90, 0x90, 0x90, 0x70],
    'v': [0x00, 0x90, 0x90, 0x90, 0x90, 0x60, 0x20],
    'w': [0x00, 0x88, 0x88, 0xA8, 0xA8, 0xD8, 0x88],
    'x': [0x00, 0x90, 0x90, 0x60, 0x60, 0x90, 0x90],
    'y': [0x00, 0x90, 0x90, 0x90, 0x70, 0x10, 0xE0],
    'z': [0x00, 0xF0, 0x10, 0x20, 0x40, 0x80, 0xF0],
})

CHAR_WIDTH = 6
CHAR_HEIGHT = 7


def draw_text_bitmap(fb, x, y, text, color=0, scale=1):
    """
    Draw text using bitmap font onto a framebuf object.
    
    Args:
        fb: framebuf.FrameBuffer object
        x, y: starting position
        text: string to draw
        color: pixel value (0 or 1 for MONO modes)
        scale: integer scaling factor (default 1)
    """
    scaled_width = CHAR_WIDTH * scale

    for char_idx, char in enumerate(text):
        if char not in BITMAP_FONT:
            char = ' '
        
        char_x = x + char_idx * scaled_width
        font_data = BITMAP_FONT[char]
        
        # Draw each row of the character
        for row_idx, row_byte in enumerate(font_data):
            char_y = y + row_idx * scale
            # Draw each bit in the row (left to right), using bits 7-3
            for bit_idx in range(5):
                pixel = (row_byte >> (7 - bit_idx)) & 1
                if pixel:
                    if scale == 1:
                         fb.pixel(char_x + bit_idx, char_y, color)
                    else:
                         fb.fill_rect(char_x + bit_idx * scale, char_y, scale, scale, color)


def text_width(text, scale=1):
    """Return the width in pixels of a text string."""
    return len(text) * CHAR_WIDTH * scale
